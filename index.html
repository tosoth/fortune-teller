<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Destiny Navigator | AI Fortune</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Added Marked.js for proper Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body {
            background: radial-gradient(circle at center, #1a1a2e 0%, #0f0f1a 100%);
            color: #e0e0ff;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        .cinzel { font-family: 'Cinzel', serif; }
        .luminous-text {
            text-shadow: 0 0 10px rgba(147, 51, 234, 0.8), 0 0 20px rgba(147, 51, 234, 0.4);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
        }
        /* Markdown Styling Overrides */
        .prose h1, .prose h2, .prose h3 { 
            font-family: 'Cinzel', serif; 
            color: #c084fc; 
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            text-shadow: 0 0 8px rgba(192, 132, 252, 0.4);
        }
        .prose h2 { font-size: 1.875rem; border-bottom: 1px solid rgba(147, 51, 234, 0.2); padding-bottom: 0.5rem; }
        .prose p { margin-bottom: 1rem; line-height: 1.7; opacity: 0.9; }
        .prose ul { list-style-type: none; padding-left: 0; }
        .prose li { 
            position: relative; 
            padding-left: 1.5rem; 
            margin-bottom: 0.75rem; 
        }
        .prose li::before {
            content: "✦";
            position: absolute;
            left: 0;
            color: #9333ea;
        }
        .prose strong { color: #fff; font-weight: 600; }

        input, select {
            background: rgba(0, 0, 0, 0.3) !important;
            border: 1px solid rgba(147, 51, 234, 0.3) !important;
            color: white !important;
        }
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #9333ea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-3xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="cinzel text-4xl md:text-5xl font-bold luminous-text mb-2 uppercase tracking-widest">Destiny Navigator</h1>
            <p class="text-purple-300 opacity-80 italic">Three Ancient Truths. One AI Vision.</p>
        </header>

        <!-- Stage 1: Language Selection -->
        <div id="stage-language" class="glass-card p-8 text-center">
            <h2 class="text-xl mb-6">Choose the language of your soul:</h2>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="setLanguage('English')" class="p-4 glass-card hover:bg-purple-900/30 transition">English</button>
                <button onclick="setLanguage('Chinese')" class="p-4 glass-card hover:bg-purple-900/30 transition">中文</button>
                <button onclick="setLanguage('Spanish')" class="p-4 glass-card hover:bg-purple-900/30 transition">Español</button>
                <button onclick="setLanguage('French')" class="p-4 glass-card hover:bg-purple-900/30 transition">Français</button>
            </div>
        </div>

        <!-- Stage 2: Profile Input -->
        <div id="stage-profile" class="glass-card p-8 hidden">
            <h2 class="cinzel text-2xl mb-6 text-center" id="profile-title">Your Birth Profile</h2>
            <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm opacity-60 mb-1">Birth Date</label>
                        <input type="date" id="birth-date" class="w-full p-3 rounded-lg outline-none">
                    </div>
                    <div>
                        <label class="block text-sm opacity-60 mb-1">Birth Time</label>
                        <input type="time" id="birth-time" class="w-full p-3 rounded-lg outline-none">
                    </div>
                    <div>
                        <label class="block text-sm opacity-60 mb-1">Gender</label>
                        <select id="gender" class="w-full p-3 rounded-lg outline-none">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Non-binary">Non-binary</option>
                        </select>
                    </div>
                </div>
                <button onclick="generateFortune()" id="btn-reveal" class="w-full bg-purple-600 hover:bg-purple-500 py-4 rounded-xl font-bold transition shadow-lg shadow-purple-900/20">
                    REVEAL MY MILESTONES
                </button>
            </div>
        </div>

        <!-- Stage 3: Results -->
        <div id="stage-result" class="space-y-8 hidden">
            <div id="loading" class="text-center py-12 flex flex-col items-center gap-4">
                <div class="loading-spinner"></div>
                <p class="animate-pulse">Consulting the Stars & Elements...</p>
            </div>
            
            <div id="content" class="space-y-6">
                <!-- AI Content will be injected here -->
            </div>

            <!-- Interaction Box -->
            <div id="interaction-box" class="glass-card p-6 mt-12 border-t-2 border-purple-500/50 hidden">
                <h3 class="cinzel text-lg mb-4">The path is still speaking... Ask me more.</h3>
                <div class="flex gap-2">
                    <input type="text" id="follow-up" placeholder="Ask about a specific year or event..." class="flex-1 p-3 rounded-lg outline-none">
                    <button id="btn-ask" onclick="sendFollowUp()" class="bg-purple-600 px-6 rounded-lg font-bold hover:bg-purple-500 transition">Ask</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; // Runtime handled
        let userLang = "English";
        let userProfile = {};

        function setLanguage(lang) {
            userLang = lang;
            document.getElementById('stage-language').classList.add('hidden');
            document.getElementById('stage-profile').classList.remove('hidden');
            
            const texts = {
                'English': { title: 'Your Birth Profile', btn: 'REVEAL MY MILESTONES' },
                'Chinese': { title: '您的出生资料', btn: '揭晓我的命运里程碑' },
                'Spanish': { title: 'Tu Perfil de Nacimiento', btn: 'REVELAR MIS HITOS' },
                'French': { title: 'Votre Profil de Naissance', btn: 'RÉVÉLER MES JALONS' }
            };
            document.getElementById('profile-title').innerText = texts[lang].title;
            document.getElementById('btn-reveal').innerText = texts[lang].btn;
        }

        async function apiCall(prompt, systemPrompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            let retries = 0;
            const delay = (ms) => new Promise(res => setTimeout(res, ms));

            while (retries < 5) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (e) {
                    retries++;
                    await delay(Math.pow(2, retries) * 1000);
                }
            }
            return "The stars are momentarily obscured. Please try again.";
        }

        async function generateFortune() {
            const date = document.getElementById('birth-date').value;
            const time = document.getElementById('birth-time').value;
            const gender = document.getElementById('gender').value;

            if(!date) return;

            userProfile = { date, time, gender };
            document.getElementById('stage-profile').classList.add('hidden');
            document.getElementById('stage-result').classList.remove('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('content').innerHTML = "";

            const systemPrompt = `You are a Master Fortune Teller. Respond in ${userLang}. 
            Format using standard Markdown (use # for titles, ## for milestones, **bold** for emphasis, and bullet points).
            RULES:
            1. No boring preamble or AI-disclaimers. 
            2. Use mystical, luminous words.
            3. Pinpoint at least 5 life milestones. 
            4. For EACH milestone include: Year/Age, Marriage/Partnership (short/long), Wealth (how rich/losses), and Breakups.
            5. Keep the user's attention with storytelling skills.`;

            const userPrompt = `Analyze for a ${gender} born on ${date} at ${time}. Give me the luminous roadmap of my life milestones.`;

            const result = await apiCall(userPrompt, systemPrompt);
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('interaction-box').classList.remove('hidden');
            
            // Use marked.js to render Markdown properly
            const htmlContent = marked.parse(result);
            document.getElementById('content').innerHTML = `<div class="glass-card p-8 prose prose-invert max-w-none">${htmlContent}</div>`;
        }

        async function sendFollowUp() {
            const input = document.getElementById('follow-up');
            const btn = document.getElementById('btn-ask');
            const question = input.value;
            if(!question) return;

            const chatDisplay = document.getElementById('content');
            chatDisplay.innerHTML += `<div class="p-4 bg-purple-900/20 rounded-lg italic text-right mb-4 text-purple-200">"${question}"</div>`;
            input.value = "";
            btn.disabled = true;
            btn.innerText = "...";

            const systemPrompt = `Continue the fortune-telling in ${userLang}. Based on ${JSON.stringify(userProfile)}, answer concisely in character. Use Markdown.`;
            const answer = await apiCall(question, systemPrompt);
            
            btn.disabled = false;
            btn.innerText = "Ask";
            
            const htmlAnswer = marked.parse(answer);
            chatDisplay.innerHTML += `<div class="glass-card p-6 mb-4 border-l-4 border-purple-500 prose prose-invert max-w-none">${htmlAnswer}</div>`;
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }
    </script>
</body>
</html>
